{"componentChunkName":"component---src-templates-lesson-template-js","path":"/volumes-and-bind-mounts","webpackCompilationHash":"2609c4b3d6818aafed4b","result":{"data":{"markdownRemark":{"html":"<p>So far we've been dealing with self-contained containers. Normally this is all you ever want: containers that can spin up and spin down as frequently as they need to. They're ephemeral, temporary, and disposable. None of these containers are \"snowflakes\". When I say snowflakes, picture you're running a server that's serving a Wordpress site. Imagine setting up this server, SSH'ing into the server, and setting everything up to be just right and tuned to the exact way you need it. This would be a snowflake server: if someone goes and deletes this server, you're screwed. You have to go and spend a bunch of time re-setting up this server. This is exactly the sort of thing we're trying to avoid with containers. We want to make our servers easy to reproduce whenever we want so we can spin up and spin down servers at will.</p>\n<p>However not everything can fit neatly into a container all the time. Sometimes our containers need to be stateful in some capacity. Sometimes our containers need to read and write to the host. This is fundamentally at odds with the idea of a stateless, able-to-create-and-destroy-anytime container that we've been adhering to thusfar. So what are we to do?</p>\n<p>Enter volumes and bind mounts. Both of these are methods of reading and writing to the host but with slight-but-important differences of when to use which. We'll go over both.</p>\n<h2 id=\"bind-mounts\"><a href=\"#bind-mounts\" aria-label=\"bind mounts permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bind Mounts</h2>\n<p>Let's start here because this is easier to see the use case for. Bind mounts allow you to mount files from your host computer into your container. This allows you to use the containers a much more flexible way than previously possible: you don't have to know what files the container will have <em>when you build it</em> and it allows you to determine those files <em>when you run it</em>.</p>\n<p>Let's go over an example of how this could be useful.</p>\n<p>In the previous project, we used the NGINX container to build a container with our static assets baked into the container. In general this what I recommend you do since now we can ship that container anywhere and it'll just work. It's totally self-contained. But what if we just want to run a NGINX container locally to test stuff out? Sure, we could make a new Dockerfile and write it, but wouldn't it be cool if we could just use the NGINX container directly? We can! Let's try it. Go back to your static site project from the previous lesson. Let's use the <code class=\"language-text\">nginx</code> container to serve directly from it.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># from the root directory of your CRA app</span>\ndocker run --mount <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>bind,source<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>\"</span>/build,target<span class=\"token operator\">=</span>/usr/share/nginx/html -p <span class=\"token number\">8080</span>:80 nginx</code></pre></div>\n<p>This is how you do bind mounts. It's a bit verbose but necessary. Let's dissect it.</p>\n<ul>\n<li>We use the <code class=\"language-text\">--mount</code> flag to identify we're going to be mounting something in from the host.</li>\n<li>As far as I know the only two types are <code class=\"language-text\">bind</code> and <code class=\"language-text\">volume</code>. Here we're using bind because we to mount in some piece of already existing data from the host.</li>\n<li>In the source, we identify what part of the host we want to make readable-and-writable to the container. It has to be an absolute path (e.g we can't say <code class=\"language-text\">&quot;./build&quot;</code>) which is why use the <code class=\"language-text\">&quot;$(pwd)&quot;</code> to get the <strong>p</strong>resent <strong>w</strong>orking <strong>d</strong>irectory to make it an absolute path.</li>\n<li>The target is where we want those files to be mounted in the container. Here we're putting it in the spot that NGINX is expecting.</li>\n<li>As a side note, you can mount as many mounts as you care to, and you mix bind and volume mounts. NGINX has a default config that we're using but if we used another bind mount to mount an NGINX config to <code class=\"language-text\">/etc/nginx/nginx.conf</code> it would use that instead.</li>\n</ul>\n<p>Again, it's preferable to bake your own container so you don't have to ship the container and the code separately; you'd rather just ship one thing that you can run without much ritual nor ceremony. But this is a useful trick to have in your pocket.</p>\n<h2 id=\"volumes\"><a href=\"#volumes\" aria-label=\"volumes permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Volumes</h2>\n<p>Bind mounts are great for when you need to share data between your host and your container as we just learned. Volumes, on the other hand, are so that your containers can maintain state between runs. So if you have a container that runs and the next time it runs it needs the results from the previous time it ran, volumes are going to be helpful. Volumes can not only be shared by the same container-type between runs but also between different containers. Maybe if you have two containers and you want to log to consolidate your logs to one place, volumes could help with that.</p>\n<p>They key here is this: bind mounts are file systems managed the host. They're just normal files in your host being mounted into a container. Volumes are different because they're a new file system that Docker manages that are mounted into your container. These Docker-managed file systems are not visible to the host system (they can be found but it's designed to be.)</p>\n<p>Let's make a quick Node.js app that reads from a file that a number in it, prints it, writes it to a volume, and finishes. Create a new Node.js project.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> docker-volume\n<span class=\"token builtin class-name\">cd</span> docker-volume\n<span class=\"token function\">touch</span> index.js Dockerfile</code></pre></div>\n<p>Inside that Node.js file, put this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>promises<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dataPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DATA_PATH</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"./data.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>dataPath<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">buffer</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">writeTo</span><span class=\"token punctuation\">(</span><span class=\"token operator\">+</span>data <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file not found, writing '0' to a new file\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">writeTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">writeTo</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span>dataPath<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Don't worry too much about the Node.js. It looks for a file <code class=\"language-text\">$DATA_PATH</code> if it exists or <code class=\"language-text\">./data.txt</code> if it doesn't and if it exists, it reads it, logs it, and writes back to the data file after incrementing the number. If it just run it right now, it'll create a <code class=\"language-text\">data.txt</code> file with 0 in it. If you run it again, it'll have <code class=\"language-text\">1</code> in there and so on. So let's make this work with volumes.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>alpine\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node . /src\n<span class=\"token keyword\">WORKDIR</span> /src\n<span class=\"token keyword\">CMD</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Now run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build --tag<span class=\"token operator\">=</span>incrementor <span class=\"token builtin class-name\">.</span>\ndocker run incrementor</code></pre></div>\n<p>Every time you run this it'll be the same thing. This is nothing is persisted once the container finishes. We need something that can live between runs. We could use bind mounts and it would work but this data is only designed to be used and written to within Docker which makes volumes preferable and recommended by Docker. If you use volumes, Docker can handle back ups, clean ups, and more security for you. If you use bind mounts, you're on your own.</p>\n<p>So, without having to rebuild your container, try this</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run --env <span class=\"token assign-left variable\">DATA_PATH</span><span class=\"token operator\">=</span>/data/num.txt --mount <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>volume,src<span class=\"token operator\">=</span>incrementor-data,target<span class=\"token operator\">=</span>/data incrementor</code></pre></div>\n<p>Now you should be to run it multiple times and everything should work! We use the <code class=\"language-text\">--env</code> flag to set the DATA_PATH to be where we want Node.js to write the file and we use <code class=\"language-text\">--mount</code> to mount a named volume called <code class=\"language-text\">incrementor-data</code>. You can leave this out and it'll be an anonymous volume that will persist beyond the container but it won't automatically choose the right one on future runs. Awesome!</p>\n<h2 id=\"named-pipes-tmpfs-and-wrap-up\"><a href=\"#named-pipes-tmpfs-and-wrap-up\" aria-label=\"named pipes tmpfs and wrap up permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>named pipes, tmpfs, and wrap up</h2>\n<p>Prefer to use volumes when you can, use bind mounts where it makes sense. If you're still unclear, the <a href=\"https://docs.docker.com/storage/\">official Docker</a> docs are pretty good on the subject.</p>\n<p>There are two more that we didn't talk about, <code class=\"language-text\">tmpfs</code> and <code class=\"language-text\">npipe</code>. The former is Linux only and the latter is Windows only (we're not going over Windows containers at all in this workshop.) <code class=\"language-text\">tmpfs</code> imitates a file system but actually keeps everything in memory. This is useful for mounting in secrets like database keys. The latter is useful for mounting third party tools for Windows containers. If you need more info than that, refer to the docs. I've never directly used either.</p>","frontmatter":{"path":"/volumes-and-bind-mounts","title":"Volumes and Bind Mounts","order":8}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"order":1,"path":"/intro","title":"Introduction"}}},{"node":{"frontmatter":{"order":2,"path":"/what-are-containers","title":"What Are Containers?"}}},{"node":{"frontmatter":{"order":3,"path":"/lxc-lxd","title":"lxc & lxd"}}},{"node":{"frontmatter":{"order":4,"path":"/docker","title":"Intro to Docker"}}},{"node":{"frontmatter":{"order":5,"path":"/dockerfile","title":"The Dockerfile"}}},{"node":{"frontmatter":{"order":6,"path":"/going-to-production","title":"Going to Production"}}},{"node":{"frontmatter":{"order":7,"path":"/static-assets-project","title":"Static Assets Project"}}},{"node":{"frontmatter":{"order":8,"path":"/volumes-and-bind-mounts","title":"Volumes and Bind Mounts"}}},{"node":{"frontmatter":{"order":9,"path":"/dev-containers","title":"Using Containers for your Dev Environment"}}},{"node":{"frontmatter":{"order":10,"path":"/networking","title":"Networking with Docker"}}},{"node":{"frontmatter":{"order":11,"path":"/docker-compose","title":"Docker Compose"}}},{"node":{"frontmatter":{"order":12,"path":"/kubernetes","title":"Kubernetes"}}},{"node":{"frontmatter":{"order":13,"path":"/buildah-podman","title":"Non-Docker Containers: Buildah and Podman"}}},{"node":{"frontmatter":{"order":14,"path":"/conclusion","title":"Conclusion"}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}